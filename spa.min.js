var spa=spa||{};
(function(b){jQuery.holdReady(!0);spa=jQuery.extend({buildTaskCount:0,$cache:{},routes:[],current:{},defualts:{shell:"index"}},spa);spa.inits=[];spa.init=function(a){spa.inits.push(a)};spa.onInit=function(){spa.inits.forEach(function(a){a()})};spa.includeScript=function(a){jQuery.ajax({url:a,dataType:"script",async:!1})};spa.includeTemplate=function(a){var c="";jQuery.ajax({url:a,success:function(a){c=a},async:!1});return c};spa.Mixer=function(){for(var a=[].slice.apply(arguments),c={create:function(e){for(var d=
{},f=0;f<a.length;f++)d=b.extend(d,a[f].create());d=b.extend(Object.create(d),c);return b.extend(Object.create(d),e||{})},__cleanUp:function(){for(var c=0;c<a.length;c++)a[c].__cleanUp&&a[c].__cleanUp.call(this)}},e={},d=0;d<a.length;d++)e=b.extend(Object.create(e),a[d]);return b.extend(Object.create(e),c)};spa.StyleSheets=function(){var a=Object.create(Array.prototype);a.create=function(){var a=[].slice.apply(arguments),e=jQuery("body");e.length&&(a.unshift(e),a=this.load.apply(this,a));return b.extend(Object.create(this),
a)};a.push=function(){var a=[].slice.apply(arguments),b=jQuery("body");b.length&&(a.unshift(b),a=this.load.apply(this,a));return Array.prototype.push.apply(this,a)};a.unload=function(a){return 0===jQuery("body ."+a).length?(a=jQuery("body style."+a),a.remove(),a=this.indexOf(a[0]),0!==~a&&this.splice(a,1),!0):!1};a.load=function(a){var b,c=[].slice.apply(arguments);c.shift();for(var f=c.length,g=0;g<f;g++)b=c[g],0===a.children('style[class="'+b.attr("class")+'"]').length?a.append(c[g]):(c.splice(g,
1),f--,g--);return c};return a}()})(jQuery);
spa.EventBase=function(){var b={listeners:{},create:function(a){return $.extend(Object.create(b),{setTimeoutMap:{},setIntervalMap:{},$container:jQuery({})},a||{})},on:function(a,b,e){return this.$container.on.apply(this.$container,arguments)},trigger:function(a,b,e){return this.$container.trigger.apply(this.$container,arguments)},setTimeout:function(a,b,e,d){this.setTimeoutMap[a]=window.setTimeout.apply(window,Array.apply(this,arguments).splice(1));return this.setTimeoutMap[a]},setInterval:function(a,
b,e,d){this.setIntervalMap[a]=window.setInterval.apply(window,Array.apply(this,arguments).splice(1));return this.setIntervalMap[a]},__clearSets:function(){for(var a in this.setIntervalMap)clearInterval(this.setIntervalMap[a]);for(a in this.setTimeoutMap)clearTimeout(this.setTimeoutMap[a])},__cleanUp:function(){this.__clearSets()},init:function(){},__topics:{},subscribe:function(a,b){var c,d=[];$.isArray(a)||(a=[a]);for(var f=a.length;f--;)c=a[f],~d.indexOf(c)||(Object.hasOwnProperty.call(this.__topics,
c)||(this.__topics[c]=[]),this.__topics[c].push(b),d.push(c))},publish:function(a,b){!this.__topics[a]||1>this.__topics[a].length||this.__topics[a].forEach(function(c){setTimeout(function(a,b){c(a||{},b)},0,b,a)})}};return Object.create(b)}();
spa.RenderBase=function(){var b={errorTemplates:{},create:function(a){return $.extend(Object.create(b),{context:{},template:"",cssRules:""},a||{})},__setUp:function(a){this.$container=a;this.$container.addClass(this.name);this.init()},__parse_style:function(){var a=jQuery('<style class="'+this.name+'-style">');a.append(this.cssRules||"");this.sheet=spa.$cache.$styleSheets.push(a)},__cleanUp:function(){this.$container.removeClass(this.name);spa.$cache.$styleSheets.unload(this.$container.attr("class")+
"-style")},init:function(){this.renderTemplate()},renderTemplate:function(a,b){this.sheet||this.__parse_style();this.$container.html(Mustache.render(this.template,jQuery.extend({},this.context,a||{}),jQuery.extend({},this.templateMap,b||{})));this.components=this.$find(this.$container)},$find:function(a,b){var c=[];a.find("[data-component-name]").each(function(a,b){var e,d=jQuery(b);e=d.data("component-name");var f=spa.components[e];e=f?d.parents('[data-component-name="'+e+'"]').length?spa.Component.errorTemplates["500"].create({context:{name:e}}):
f():spa.Component.errorTemplates["404"].create({context:{name:e}});c.push(e);e.__setUp(d)});return c},$insert:function(a,b){var c;c=a.data("component-name");var d=spa.components[c];c=d?a.parents('[data-component-name="'+c+'"]').length?spa.Component.errorTemplates["500"].create({context:{name:c}}):d(b||{}):spa.Component.errorTemplates["404"].create({context:{name:c}});this.components.push(c);c.__setUp(a);return c}};return Object.create(b)}();spa.services={};
spa.Service=function(){var b=Object.create(spa.EventBase);b.add=function(a){if(!a.name)return!1;a=this.create(a);a.init();spa.services[a.name]=a};return b}();spa.models={};spa.Model=function(){var b=Object.create(spa.EventBase);b.add=function(a){if(!a.name)return!1;a=this.create(a);spa.models[a.name]=a;a.init()};return b}();spa.RenderBase.errorTemplates["404"]=spa.RenderBase.constructor({template:"<center><h1><i>Page {{name}} Not Found</i></h1>{{message}}<center>",title:"404"});
spa.RenderBase.errorTemplates["500"]=spa.RenderBase.constructor({title:"500",template:"<center><h1><i>SPA error {{name}}</i></h1>{{message}}<center>"});spa.shells={};
spa.Shell=function(){var b={defaultContainerSelector:"#spa-shell",add:function(a){if(!a.name)return!1;a=this.create(a);spa.shells[a.name]=a},renderTemplate:function(a,b){spa.RenderBase.renderTemplate.call(this,a)},update:function(a){a=a||spa.shells[spa.defaults.shell];if(spa.current.shell===a)return!1;spa.current.shell&&spa.current.shell.unload();spa.current.shell=a;a.__setUp(this.$container)},unload:function(){this.__cleanUp();(this.components?this.components:[]).forEach(function(a){b.unload.call(a)}.bind(this))},
create:function(a){return $.extend(Object.create(b),a||{})}};return spa.Mixer(spa.EventBase,spa.RenderBase,b)}();spa.components={};spa.Component=function(){var b={add:function(a){if(!a.name)return!1;spa.components[a.name]=function(b){return this.create($.extend(Object.create(a),b))}.bind(this)},create:function(a){return $.extend(Object.create(b),a||{})}};return spa.Mixer(spa.EventBase,spa.RenderBase,b)}();
spa.Form=function(){var b={errorMessageClass:"input-error-message",add:function(a){if(!a.name)return!1;spa.components[a.name]=function(b){return this.create(jQuery.extend(Object.create(a),b))}.bind(this)},renderErrors:function(a){var b=this;b.$container.find("."+b.errorMessageClass).remove();jQuery.each(a,function(a,c){if(Object.hasOwnProperty.call(b,"set"+a+"Error"))b["set"+a+"Error"](a,c);else b.setError(a,c)})},setError:function(a,b){var c=this,d=this.getErrorTarget(a);b.prototype!==Array.prototype&&
(b=[b]);jQuery.each(b,function(a,b){d.append('<span class="'+c.errorMessageClass+'">'+b+"</span>")})},getErrorTarget:function(a){return this.$container.find('[for="'+a+'"]')},create:function(a){return $.extend(Object.create(b),a||{})}};return spa.Mixer(spa.EventBase,spa.RenderBase,b)}();spa.routes=[];
spa.Router={defaultRoute:spa.routes,add:function(b){if($.isArray(b))b.forEach(this.add);else{if(!b.uri&&!b.init)return!1;spa.routes.push(b);return!0}},lookup:function(b,a){var c=!1;b=b.replace(/^\/+/,"");a=a||this.defaultRoute;a.some(function(a){var d=XRegExp.exec(b,XRegExp(a.uri,"ix"));if(d)return a.REQ={url:b,re:d},c=a,!0});return c},resolver:function(b,a){a=void 0===a?!0:a;var c=this.lookup(b);c||(c=spa.RenderBase.errorTemplates["404"],c.context={name:b});c.init();spa.Shell.update(c.shell);a&&
spa.Router.historyAdd({url:b},c.title,b)},historyAdd:function(b,a,c){window.history.pushState(b,a,c)}};
spa.init(function(){spa.$cache.$styleSheets=spa.StyleSheets.create();spa.EventBase.subscribe("__dom-content-loaded-start",function(){spa.$cache.$loader=jQuery("#spa-loader-holder");spa.$cache.$body=jQuery("body");var b=[].slice.call(spa.$cache.$styleSheets);b.length&&(b.unshift(jQuery("head")),spa.$cache.$styleSheets.load.apply({},b));spa.Shell.$container=jQuery(spa.Shell.defaultContainerSelector);jQuery(window).on("popstate",function(a){spa.EventBase.publish("load-shell",{path:window.location.pathname,
isHistory:!1})});spa.$cache.$body.on("click",".ajax-link",function(a){a.preventDefault();spa.EventBase.publish("load-shell",{path:jQuery(this).attr("href"),isHistory:!0});return!1})});spa.EventBase.subscribe("__spa-ready",function(){jQuery.holdReady(!1);spa.EventBase.publish("load-shell",{path:window.location.pathname,isHistory:!1})});spa.EventBase.subscribe("load-shell",function(b){spa.Router.resolver(b.path,b.isHistory);spa.$cache.$loader.hide();spa.Shell.$container.show()});(function(){var b=spa.buildTaskCount;
spa.EventBase.subscribe("__dom-content-loaded-end",function(a){0===b&&spa.EventBase.publish("__spa-ready");b--});spa.EventBase.subscribe("spa-build-task-complete",function(a){0===b&&spa.EventBase.publish("__spa-ready");b--})})()});jQuery(document).on("DOMContentLoaded",function(b){spa.EventBase.publish("__dom-content-loaded-start");spa.EventBase.publish("__dom-content-loaded-end")});
